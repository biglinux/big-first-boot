#!/bin/bash

# Fix some slowdown in network
# systemctl stop NetworkManager-wait-online
# systemctl disable NetworkManager-wait-online

if [ ! -e "/livefs-pkgs.txt" ]; then

    #Enable automatic update grub and configure timeshift
     if [ "$(grep btrfs /etc/fstab)" != "" ]; then
        sed -i 's|^ *\bPathModified\b *=.*|PathModified=/run/timeshift/backup/timeshift-btrfs/snapshots|' /usr/lib/systemd/system/grub-btrfs.path
        systemctl reenable grub-btrfs.path
        systemctl start grub-btrfs
        timeshift --btrfs
        sed -i 's|"schedule_daily" : "false"|"schedule_daily" : "true"|g;s|"btrfs_mode" : "false"|"btrfs_mode" : "true"|g' /etc/timeshift/default.json
        sed -i 's|"schedule_daily" : "false"|"schedule_daily" : "true"|g;s|"btrfs_mode" : "false"|"btrfs_mode" : "true"|g;s|"btrfs_use_qgroup" : "true"|"btrfs_use_qgroup" : "false"|g' /etc/timeshift/timeshift.json
        timeshift --check
     fi
    
    vbox=$(lspci | grep -i "virtualbox")
    qemu=$(lspci | grep -i "virtio")
    if [ -z "$vbox" ]; then
        rm_vbox="virtualbox-guest-utils"
    fi

    if [ -z "$qemu" ]; then
        rm_spice="spice-vdagent spice-vdagent-autostart-kde"
    fi
    
    if [ -z "$vbox" -a -z "$qemu" ];then
        rm_virt="open-vm-tools qemu-guest-agent libdnet gdk-pixbuf-xlib uriparser libmspack xf86-input-vmmouse"
    fi



    #pacman -R --noconfirm linux414-headers
    pacman -R --noconfirm $rm_spice
    pacman -R --noconfirm $rm_vbox
    pacman -R --noconfirm $rm_virt
    pacman -R --noconfirm big-first-boot
    
    
    # mostrar * ao digitar senha no terminal
    echo "Defaults pwfeedback" | tee -a /etc/sudoers
    
fi

