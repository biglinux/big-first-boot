#!/bin/bash

# Fix some slowdown in network
systemctl stop NetworkManager-wait-online
systemctl disable NetworkManager-wait-online

if [ ! -e "/livefs-pkgs.txt" ]; then

    
    #Enable automatic update grub and configure timeshift
     if [ "$(grep btrfs /etc/fstab)" != "" ]; then
        sed -i 's|^ *\bPathModified\b *=.*|PathModified=/run/timeshift/backup/timeshift-btrfs/snapshots|' /usr/lib/systemd/system/grub-btrfs.path
        systemctl reenable grub-btrfs.path
        timeshift --btrfs
        sed -i 's|"schedule_daily" : "false"|"schedule_daily" : "true"|g;s|"btrfs_mode" : "false"|"btrfs_mode" : "true"|g' /etc/timeshift/default.json
        sed -i 's|"schedule_daily" : "false"|"schedule_daily" : "true"|g;s|"btrfs_mode" : "false"|"btrfs_mode" : "true"|g;s|"btrfs_use_qgroup" : "true"|"btrfs_use_qgroup" : "false"|g' /etc/timeshift/timeshift.json
        timeshift --check
        btrfs quota disable /
     fi
    
    vbox=$(lspci | grep -i "virtualbox")
    qemu=$(lspci | grep -i "virtio")
    if [ -z "$vbox" ]; then
        rm_vbox="virtualbox-guest-utils"
        rm_pwconfig="pipewire-biglinux-config-git"
    fi

    if [ -z "$qemu" ]; then
        rm_spice="spice-vdagent spice-vdagent-autostart-kde"
    fi

    pacman -R --noconfirm linux414-headers
    pacman -R --noconfirm big-first-boot $rm_spice $rm_vbox $rm_pwconfig
    
    # Change clock
    timedatectl set-local-rtc 1 --adjust-system-clock
    
    # fix grub in uefi + cryptography
    #sed -i 's|splashquiet|splash quiet|g' /etc/default/grub
    
    # Fix to nvidia prime
    #prime-select on-demand

	# Fix grub theme
	#cd /usr/share/grub-bgrt/
	#./install.sh

    #Disable first boot


#     # Fix dpi
#     if [ "$(cat /proc/cmdline | grep "fixdpi")" != "" ]; then
#             nvidia-xconfig --no-use-edid-dpi
#     fi
# 
# else
# 
#     if [ "$(cat /proc/cmdline | grep "nouveau.modeset=0 i915.modeset=0")" != "" ]; then
# 
#         mv /usr/src/linux-headers-*xanmod* /usr/
# 
#         apt -y -o APT::Install-Recommends=true install $(nvidia-detector)
#         
#         # Fix to nvidia prime
#         prime-select on-demand
#         
#         #modprobe nvidiafb
#         #modprobe nvidia-modeset
#         modprobe nvidia-uvm
#         modprobe nvidia-drm
#         modprobe nvidia
#         
#         # Fix dpi
#         if [ "$(cat /proc/cmdline | grep "fixdpi")" != "" ]; then
#             nvidia-xconfig --no-use-edid-dpi
#         fi
#     fi
fi


